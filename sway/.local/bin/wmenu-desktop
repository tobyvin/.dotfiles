#!/bin/sh

cache="${XDG_CACHE_HOME:-"$HOME/.cache"}/wmenu-desktop"

if [ $# -eq 0 ]; then
	printf '%s\n' "$XDG_DATA_HOME" "$XDG_DATA_DIRS" |
		tr ':' '\n' |
		sed 's|/\?$|/applications|' |
		xargs fd . --extension=.desktop -X desktop-entry.awk \; 2>/dev/null |
		sort -t'	' -uk2 |
		tee "$cache" | cut -f2
	exit 0
fi

if [ "$1" = '-' ]; then
	args="$(cat -)"
	if [ -z "$args" ]; then
		exit 0
	fi
	set -- "$args"
fi

while IFS='	' read -r entry name; do
	if [ "$name" = "$1" ]; then
		file="${entry%:*}"
		if [ "$file" != "$entry" ]; then
			action=${entry#*:}
		fi
		break
	fi
done <"$cache"

if [ -z "$file" ]; then
	printf 'Failed to find "%s" in cache.\n' "$1" >&2
	exit 1
fi

awk -v term="$TERMINAL" -v action=${action+"$action"} -f - "$file" <<-"EOF" |
	BEGIN {
		FS = "="
		found = 0
		terminal = 0
		name = ""
		icon = ""
		exec = ""
	}
	$0 == "[Desktop " (action ? "Action " action : "Entry" ) "]" { found = 1; next }
	$1 == "Icon" { sub("^Icon\\s*=\\s*", "--icon "); icon = $0 }
	$1 == "Terminal" && $2 ~ "true" { terminal = 1 }
	found == 0 { next }
	/^\[Desktop .*]$/ { nextfile }
	$1 == "Name" { sub("^Name\\s*=\\s*", ""); name = $0 }
	$1 == "Exec" { sub("^Exec\\s*=\\s*", ""); exec = $0 }
	END {
		gsub("%[fFuUdDnNvm]", "", exec)
		gsub("%i", icon, exec)
		gsub("%c", name, exec)
		gsub("%k", FILENAME, exec)
		if (terminal) { exec = term " -T '" name "' -e " exec }
		if (exec != "") { print exec }
	}
EOF
	xargs -r swaymsg exec --
