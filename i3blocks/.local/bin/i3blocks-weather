#!/usr/bin/env python3

from enum import Enum
import os
import re
import subprocess
import sys

import requests


class NFWeather(Enum):
    Clear = ("", "")
    Cloudy = ("", "")
    PartlyCloudy = ("", "")
    Fog = ("", "")
    Hail = ("", "")
    Haze = ("", "")
    Lightning = ("", "")
    Rain = ("", "")
    Showers = ("", "")
    Sleet = ("", "")
    Snow = ("", "")
    Sprinkle = ("", "")
    Thunderstorm = ("", "")
    Windy = ("", "")
    CloudyGusts = ("", "")
    CloudyHigh = ("", "")
    CloudyWindy = ("", "")
    LightWind = ("", "")
    RainMix = ("", "")
    RainWind = ("", "")
    SleetStorm = ("", "")
    SnowThunderstorm = ("", "")
    SnowWind = ("", "")
    StormShowers = ("", "")


WMO_CODES = {
    0: NFWeather.Clear,  # Sunny
    1: NFWeather.PartlyCloudy,  # MainlySunny
    2: NFWeather.CloudyHigh,  # PartlyCloudy
    3: NFWeather.Cloudy,  # Cloudy
    45: NFWeather.Fog,  # Foggy
    48: NFWeather.Fog,  # Foggy
    51: NFWeather.Sprinkle,  # LightDrizzle
    53: NFWeather.Rain,  # Drizzle
    55: NFWeather.RainWind,  # HeavyDrizzle
    56: NFWeather.Sleet,  # LightFreezingDrizzle
    57: NFWeather.Sleet,  # FreezingDrizzle
    61: NFWeather.Sprinkle,  # LightRain
    63: NFWeather.Rain,  # Rain
    65: NFWeather.RainWind,  # HeavyRain
    66: NFWeather.Sleet,  # LightFreezingRain
    67: NFWeather.Sleet,  # FreezingRain
    71: NFWeather.Snow,  # LightSnow
    73: NFWeather.Snow,  # Snow
    75: NFWeather.SnowWind,  # HeavySnow
    77: NFWeather.Hail,  # SnowGrains
    80: NFWeather.Sprinkle,  # LightShowers
    81: NFWeather.Showers,  # Showers
    82: NFWeather.StormShowers,  # HeavyShowers
    85: NFWeather.Snow,  # LightSnowShowers
    86: NFWeather.SnowWind,  # SnowShowers
    95: NFWeather.Thunderstorm,  # Thunderstorm
    96: NFWeather.SnowThunderstorm,  # LightThunderstormsWithHail
    99: NFWeather.SleetStorm,  # ThunderstormWithHail
}


class Weather:
    exception: Exception | None
    temp: str
    code: NFWeather
    icon: str
    unit: str

    def __init__(self, data, exception=None):
        self.exception = exception
        if exception is not None:
            self.temp = "x"
            self.code = NFWeather.Clear
        else:
            self.temp = "{}{}".format(
                data["current"]["temperature_2m"],
                data["current_units"]["temperature_2m"],
            )
            self.code = WMO_CODES[data["current"]["weather_code"]]
        self.icon = self.code.value[data["current"]["is_day"]]

    def print(self):
        print(" {} {} ".format(self.icon, self.temp))
        if self.temp == "x":
            print(f"#{os.environ.get('BASE16_COLOR_00_HEX')}")
            print(f"#{os.environ.get('BASE16_COLOR_08_HEX')}")

    def notify(self):
        title = "Current Weather"
        desc = " ".join(re.findall("[A-Z][^A-Z]*", self.code.name))
        if self.exception:
            body = "Error: {}".format(self.exception)
        else:
            body = "Weather: {} {}\nTemperature: {}".format(self.icon, desc, self.temp)
        subprocess.run(["notify-send", title, body])


BASE_URL = "https://api.open-meteo.com/v1/forecast?current=temperature_2m,weather_code,is_day&timezone=auto&forecast_days=1&latitude={latitude}&longitude={longitude}"


def get_weather():
    (lat, long) = requests.get("https://ipinfo.io").json().get("loc", ",").split(",", 1)
    return requests.get(BASE_URL.format(latitude=lat, longitude=long)).json()


def main():
    try:
        weather = Weather(get_weather())
    except Exception as e:
        e.add_note("Failed to get weather API")
        print(e, file=sys.stderr)
        weather = Weather({}, e)

    weather.print()

    match int(os.environ.get("BLOCK_BUTTON", "0")):
        case 1:
            weather.notify()


if __name__ == "__main__":
    main()
