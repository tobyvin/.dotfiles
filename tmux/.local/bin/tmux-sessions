#!/bin/sh

if [ "$#" -eq 0 ]; then
	ATTACHED=$(tmux display -p '#S' 2>/dev/null)

	# shellcheck disable=2016,2046
	set -- $(
		sshr -t -L "default" --exclude="$ATTACHED" |
			fzf-tmux "$FZF_TMUX_OPTS" -- --select-1 --exit-0 --preview-window=right,80% --preview='tmux capture-pane -ep -t {}' \
				--bind 'ctrl-q:execute(tmux kill-session -t{})+reload(tmux list-sessions -F "#{session_name}" 2>/dev/null |
        sed "/$(tmux display-message -p "#S")/d" )'
	)
fi

if [ "$#" -eq 0 ]; then
	exit 0
fi

if [ -z "$TMUX" ]; then
	tmux attach-session -t "$1"
else
	tmux switch-client -t "$1"
fi
