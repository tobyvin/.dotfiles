#!/bin/sh
# shellcheck disable=2016,2089

if [ "$#" -eq 0 ]; then
	PROJECT_DIR="$HOME/src"
	DOCKER_DIR="$HOME/dkr"
	SESSION_DIR="$XDG_DATA_HOME/nvim/sessions"
	PREVIEW_CMD="([ -n {} ] && less {}) || ([ ! -e {q} ] && less {q})"

	ATTACHED=$(tmux display -p '#{session_path}')
	lines=$(tmux display -p "#{pane_height}")
	columns=$(tmux display -p "#{pane_width}")
	WIDTH=$([ "$columns" -gt "120" ] && printf %s "120" || printf %s "90%")
	HEIGHT=$([ "$lines" -gt "40" ] && printf %s "40" || printf %s "90%")

	# shellcheck disable=2046
	set -- $({
		printf %s\\n "$HOME/.dotfiles"
		fd . "$PROJECT_DIR" "$DOCKER_DIR" --type=d --max-depth=1
		fd . "$SESSION_DIR" --type=f --max-depth=1 | sed "s|^$SESSION_DIR/||" | sed 's#%%\|__#/#g'
	} | sed 's|/$||' | sed "\|^$HOME\$|d" | sed "\|^$ATTACHED\$|d" | sort -u |
		timestamp.sh --git --sessions="$SESSION_DIR" --format="{}:{1}" | sort -r | cut -d':' -f2 |
		fzf-tmux -p "$WIDTH,$HEIGHT" -- --multi --print-query -d/ --with-nth -1 --preview-window='right,75%,<80(up,75%,border-bottom)' --preview="$PREVIEW_CMD" |
		tr -s '\n' ' ')
fi

while [ $# -gt 0 ]; do
	session_path="$1"
	shift
	if [ ! -d "$session_path" ]; then
		repo=$(printf %s "$session_path" | sed 's/.git$//' | sed 's|/$||')
		remotes="$repo https://git.sr.ht/$repo https://github.com/$repo"
		for remote in $remotes; do
			if timeout 3s git ls-remote "$remote" CHECK_GIT_REMOTE_URL_REACHABILITY; then
				session_path="$HOME/src/$(basename "$remote")"
				git clone "$remote" "$session_path"
				break
			fi
		done
	fi

	if [ ! -d "$session_path" ]; then
		continue
	fi

	name=$(basename "$session_path" | tr . _)
	if ! tmux has-session -t="$name" 2>/dev/null; then
		tmux new-session -ds "$name" -c "$session_path"
	fi
done

if [ -z "$TMUX" ] && [ -z "$name" ]; then
	tmux attach-session -t "$name"
elif tmux has-session -t="$name" 2>/dev/null; then
	tmux switch-client -t "$name"
fi
