#!/bin/sh

if [ "$#" -eq 0 ]; then
	ATTACHED=$(tmux display -p '#S' 2>/dev/null)
	HOST=$(tmux display -p '#{host}' 2>/dev/null)

	set -- "$(
		(
			tmux display -p '#{?#{m:*ssh,#{socket_path}},localhost,}' 2>/dev/null
			grep -P '^[Hh]ost ([^*]+)$' "$HOME/.ssh/config" | grep -Po ' \K(\w+)' | sed "\|^$HOST\$|d" |
				sed "\|^${ATTACHED}\$|d" |
				sort -u |
				timestamp.sh --type="ssh" --format="{}:{1}" |
				sort -r |
				cut -d':' -f2
		) |
			sed '\|^$|d' |
			fzf-tmux -p20%,20% -- --print-query -d/ --with-nth -1 |
			tail -1
	)"
fi

if [ -z "$1" ]; then
	exit 0
fi

if [ "$1" = "localhost" ] || [ "$1" = "$HOST" ]; then
	tmux detach -E 'tmux new -A'
else
	if ! tmux -L ssh has-session -t "$1"; then
		tmux -L ssh new-session -ds "$1" ssh -t "$1" "zsh -l -c 'tmux new -A'"
	fi

	if [ -z "$TMUX" ]; then
		tmux -L ssh attach -t "$1"
	else
		tmux detach -E "tmux -L ssh attach -t $1"
	fi
fi
